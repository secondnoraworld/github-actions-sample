#!/bin/sh

set -eu

main() {
  pr_list=$(
    # Get merge commits
    git --no-pager log --oneline --reverse --merges origin/"$MAIN"..origin/"$DEVELOP" |

    # Extract merge commit hashes
    awk '{ print $1 }' |

    # Retrieve PR numbers, titles, and authors from JSONs
    #
    #   Memo:
    #     Call as many APIs as PRs
    #     I'm not sure how to put all calls together
    xargs -I {} gh api "https://api.github.com/repos/$REPOSITORY/commits/{}/pulls" --jq '.[] | "\(.number) \(.title) \(.user.login)"' |

    # Add "#" at the beginning of PR numbers and "@" at the beginning of authors
    #
    #   Before:
    #     124 Add ability noraworld
    #     129 Fix bug noraworld
    #     130 Update README noraworld
    #   After:
    #     #124 Add ability @noraworld
    #     #129 Fix bug @noraworld
    #     #130 Update README @noraworld
    #
    #   Memo:
    #     PR numbers with "#" and authors with "@" is automatically turned into links
    #     So there is no need to make links manually
    awk '{ print "* [ ] #" $1 " " $2 " @" $3 }'
  )

  # echo "$pr_list"
  gh pr comment "$PR" --body "$pr_list"
  # gh api "https://api.github.com/repos/$REPOSITORY/commits/$merge_commits/pulls" --jq .[].number
}

main "$@"

# gh api "https://api.github.com/repos/secondnoraworld/github-actions-sample/commits/8fd9309c755c18678ff2f8d55ab92a3426c2d2d5/pulls" --jq .[].number
# 109
