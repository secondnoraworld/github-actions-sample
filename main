#!/bin/bash

set -eu

main() {
  pr_list_json=$(
    # Get merge commits
    git --no-pager log --oneline --reverse --merges origin/"$BASE"..origin/"$HEAD" |

    # Extract merge commit hashes
    awk '{ print $1 }' |

    # Retrieve a JSON from an API
    #
    #   Memo:
    #     Call as many APIs as PRs
    #     I'm not sure how to put all calls together
    xargs -I {} gh api "https://api.github.com/repos/$REPOSITORY/commits/{}/pulls"
  )

  if $CHECKBOX; then
    checkboxes="* [ ] "
  else
    checkboxes="* "
  fi

  pr_numbers=$(echo "$pr_list_json" | jq -r .[].number | sed -e 's/^/#/g')

  if $TITLE; then
    titles=$(echo "$pr_list_json" | jq -r .[].title)
  else
    titles=""
  fi

  if $AUTHOR; then
    authors=$(echo "$pr_list_json" | jq -r .[].user.login | sed -e 's/^/@/g')
  else
    authors=""
  fi

  aaaaa=$(paste -d " " <(echo "$pr_numbers") <(echo "$titles") <(echo "$authors") | sed -e "s/^/$checkboxes/g")

  # echo "$aaaaa"
  gh pr comment "$PR" --body "$aaaaa"
}

main "$@"
